!function(e){var t={};function i(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(a,n,function(t){return e[t]}.bind(null,n));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i(i.s=26)}({1:function(e,t,i){"use strict";i.d(t,"e",(function(){return a})),i.d(t,"d",(function(){return n})),i.d(t,"h",(function(){return r})),i.d(t,"c",(function(){return c})),i.d(t,"b",(function(){return s})),i.d(t,"g",(function(){return o})),i.d(t,"f",(function(){return d})),i.d(t,"a",(function(){return h}));const a=async e=>new Promise((t,i)=>{const a=new XMLHttpRequest;a.onload=e=>{e?t(e.target.response):i()},a.responseType="arraybuffer",a.open("GET",e,!0),a.send()}),n=e=>{try{const t=window.top||window,{hostname:i,pathname:a}=t.location;return"messenger"===e?i.includes("www.facebook.com")&&a.includes("videocall"):i.includes(e)}catch(t){return!1}},r=e=>new Promise(t=>setTimeout(t,e)),c=e=>{if(!e||!e.audio)return;const{audio:t}=e;if(t.mandatory&&t.mandatory.sourceId)return t.mandatory.sourceId;if(t.deviceId){return"string"===typeof t.deviceId?t.deviceId:t.deviceId.exact}if(t.optional&&t.optional.length){const e=t.optional.find(e=>e.sourceId);return e&&e.sourceId}},s=async(e="default")=>{try{return(await navigator.mediaDevices.enumerateDevices()).find(t=>t.deviceId===e&&"audioinput"===t.kind)}catch(t){return}},o=e=>{e&&e.getAudioTracks().forEach(e=>{e.stop()})},d=(e,t,i)=>{Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0})},h=(e,t)=>e>8e3!==t>8e3},26:function(e,t,i){e.exports=i(27)},27:function(e,t,i){"use strict";i.r(t);i(28);var a=i(1),n=i(5);const r=navigator.mediaDevices.getUserMedia,c=navigator.getUserMedia,s=navigator.webkitGetUserMedia,o=(e,t)=>{const{message:i,stack:a,name:r}=e,c={message:i,stack:a,name:r};Object(n.c)("capturePatchError",{err:c,path:t})},d=Object(a.d)("bluejeans.com"),h=Object(a.d)("uberconference.com"),u=Object(a.d)("app.slack.com"),l=Object(a.d)("messenger"),g=Object(a.d)("messenger.com"),m=Object(a.d)("webex.com"),v=Object(a.d)("meet.jit.si"),f=Object(a.d)("tryca.st"),b=Object(a.d)("web.skype.com"),p=Object(a.d)("online-voice-recorder.com"),w=Object(a.d)("meet.google.com");new class{constructor(){this.configs={canPatch:!1,muteNoise:!1,model16:this.getAttr("model16"),model8:this.getAttr("model8"),workletScript:this.getAttr("workletURL")},this.allStreams=[],this.streams=[],this.deviceStreams={},this.stream,this.device,this.patchInterval=null,this.filter=null,this.audioCtx=null,window.addEventListener("appState",this.onAppStateChange.bind(this)),navigator.mediaDevices.ondevicechange=this.onDeviceChange.bind(this),navigator.mediaDevices.getUserMedia=this.getUserPatchMedia.bind(this,r),navigator.webkitGetUserMedia=this.getUserPatchOldMedia.bind(this,s),b||(navigator.getUserMedia=this.getUserPatchOldMedia.bind(this,c)),Object(n.c)("canPatch")}onSetInterval(e,t,i){this[e]&&clearInterval(this[e]),this[e]=setInterval(t,i||1e3)}getAttr(e){return document.currentScript.getAttribute(e)}onAppStateChange({detail:e}){if(!e)return;const{canPatch:t,muteNoise:i}=e;this.configs.muteNoise=i,void 0!==t&&t&&(this.configs.canPatch=!0),this.toggleMuteNoice(i)}toggleMuteNoice(e){if(!this.filter)return;const t=this.configs.canPatch&&e;this.filter.parameters.get("enabled").value=t?1:0}sendPatchedStreamData(e){if(this.patchInterval)return;const t=()=>{const t=this.device&&this.device.label,{currentTime:i,baseLatency:a,state:r,sampleRate:c}=e,s={currentTime:i,baseLatency:a,state:r,sampleRate:c,micName:t};"running"===r&&Object(n.c)("stream",s)};this.configs.canPatch?this.patchInterval=setInterval(t,1e3):o("Has Stream Need To Login","patchingWithoutSignin")}async isDeviceChanged(e){if(!this.device)return!0;const t=await Object(a.b)(e);return!t||t.label!==this.device.label}cleanOldStream(){const[e,...t]=this.streams.reverse();this.streams=[e],t.forEach(a.g)}callGetUserMediaWithNewDevice(e){Object(a.g)(this.stream);const t=(e=>l||g||m||d||p?e.deviceId:e.groupId)(e),i={audio:{[u?"groupId":"deviceId"]:{exact:t}}};w||navigator.mediaDevices.getUserMedia.call(this,i)}async onDeviceChange(){try{if(!this.stream)return;const e=new AudioContext,t=await Object(a.b)(),i=t&&t.getCapabilities(),n=!this.device||t&&t.label!==this.device.label,r=Object(a.a)(this.audioCtx.sampleRate,e.sampleRate),c=this.device&&"default"===this.device.deviceId;r&&!this.isChanging&&(this.isChanging=!0,await this.audioCtx.close(),await this.filter.disconnect(),Object(a.g)(this.stream),this.audioCtx=e,await this.addWorkletAndModel(),this.isChanging=!1),n&&!r&&!this.isChanging&&c&&i&&this.callGetUserMediaWithNewDevice(i)}catch(e){o(e,"patch_onDeviceChange")}}checkIfHasActiveStream(){return this.streams.find(e=>e.active)}async checkActiveStreamAndClean(){if(h||d){await Object(a.h)(1e3);const e=this.streams.filter(e=>e.active);e.length>=2&&(h&&Object(a.g)(e[e.length-1]),d&&Object(a.g)(e[0]))}(u||m)&&this.streams.forEach(e=>{e.active&&e.device.deviceId!==this.device.deviceId&&Object(a.g)(e)})}async addModel(){try{const{model8:e,model16:t,muteNoise:i}=this.configs,n=this.audioCtx.sampleRate<=8e3?e:t,r=await Object(a.e)(n);this.filter.port.postMessage({type:"init",data:r}),this.toggleMuteNoice(i)}catch(e){o(e,"patch_addModel")}}async addWorklet(){try{const{workletScript:e}=this.configs;await this.audioCtx.audioWorklet.addModule(e),this.filter=new AudioWorkletNode(this.audioCtx,"krisp-processor")}catch(e){o(e,"patch_addWorklet")}}async addWorkletAndModel(){try{if(this.audioCtx&&"running"!==this.audioCtx.state&&this.audioCtx.resume(),this.filter||this.audioCtx)return;this.audioCtx=new AudioContext,await this.addWorklet(),await this.addModel()}catch(e){this.audioCtx=null,o(e,"patch_addWorkletAndModel")}}async checkCompatibility(e,t){try{this.allStreams.push(t);let i=!e.audio;if(f&&e.audio){const i=e.audio.mandatory;i&&Object.keys(i).length>1&&Object(a.f)(t,"noSource",!0)}if(this.device&&u){await Object(a.h)(300);const e=await Object(a.b)(),i="default"===this.device.deviceId,n=e&&"default"===e.deviceId;i&&n&&this.device.groupId!==e.groupId&&(Object(a.f)(t,"noSource",!0),this.onDeviceChange())}if(this.stream&&e.audio&&(l||g)){const t=Object(a.c)(e),n=!await this.isDeviceChanged(t)&&this.stream.active,r=this.allStreams.filter(e=>e.active);n&&r.length>2&&(i=!0)}if(v){const t=Object(a.c)(e);t&&t.includes("WebAudio")&&(i=!0)}if(m&&"boolean"===typeof e.audio&&(i=!0),i)throw new Error}catch(i){throw new Error(i)}}patchTrack(e,t){const i=new MediaStream([e]),n=this.audioCtx.createMediaStreamSource(i),r=this.audioCtx.createMediaStreamDestination();t.noSource||n.connect(this.filter),this.filter.connect(r),r.stream.oninactive=e=>{d?this.cleanOldStream():i.getAudioTracks()[0].stop(),this.checkIfHasActiveStream()||r.context.suspend()},this.sendPatchedStreamData(r.context);const c=r.stream.getAudioTracks()[0];return Object(a.f)(c,"label",e.label),(l||g)&&(Object(a.f)(c,"getConstraints",()=>e.getConstraints()),Object(a.f)(c,"getSettings",()=>e.getSettings())),c}async patchStream(e,t){try{await this.checkCompatibility(e,t),await this.addWorkletAndModel();const i=new MediaStream;t.getAudioTracks().forEach(e=>i.addTrack(this.patchTrack(e,t))),t.getVideoTracks().forEach(e=>i.addTrack(e));const n=Object(a.c)(e),r=await Object(a.b)(n);return Object(a.f)(t,"device",r),this.stream=t,this.streams.push(t),this.device=r,setTimeout(this.checkActiveStreamAndClean.bind(this),1e3),i}catch(i){return t}}getUserPatchMedia(e,t){return e.call(navigator.mediaDevices,t).then(this.patchStream.bind(this,t)).catch(console.error)}getUserPatchOldMedia(e,t,i,a){return e.call(navigator,t,async e=>i(await this.patchStream(t,e)),e=>a(e))}}},28:function(e,t){void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e,t,i){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a?new Promise((function(t,i){a.call(navigator,e,t,i)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})},5:function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return r})),i.d(t,"d",(function(){return c}));const a=(e,t)=>new Promise((i,a)=>{chrome.runtime.sendMessage({msg:e,data:t},e=>{i(e)})}),n=(e,t)=>{chrome.runtime.sendMessage({msg:e,data:t})},r=(e,t)=>{(window!==window.top?window.parent:window).dispatchEvent(new CustomEvent(e,{detail:t}))},c=(e,t)=>{window.dispatchEvent(new CustomEvent(e,{detail:t}))}}});